---
# =============================================================================
# Cert-Manager Role
# =============================================================================

- name: Add Jetstack Helm repository
  kubernetes.core.helm_repository:
    name: jetstack
    repo_url: https://charts.jetstack.io
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Create cert-manager namespace
  kubernetes.core.k8s:
    state: present
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: cert-manager

- name: Install Cert-Manager
  kubernetes.core.helm:
    name: cert-manager
    chart_ref: jetstack/cert-manager
    release_namespace: cert-manager
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    create_namespace: false
    values:
      installCRDs: true
    wait: yes
    timeout: 10m0s

- name: Wait for Cert-Manager webhook to be ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: cert-manager
    label_selectors:
      - app.kubernetes.io/name=webhook
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    wait: yes
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: 300
