---
# =============================================================================
# Kustomization - Production Environment
# =============================================================================
# Production overlay with:
# - Higher replica counts
# - Full resource allocation
# - All mocks disabled
# - Production-grade configuration
# - TLS enabled
# =============================================================================

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: orange-wallet

# Resources from base
resources:
  - ../../base/authentication-service
  - ../../base/user-service
  - ../../base/transaction-service
  - ../../base/wallet-service
  - ../../base/api-gateway
  - ../../base/ingress.yaml
  - ../../base/network-policies.yaml

# Patches for production environment
patches:
  # Increase replicas for high availability
  - target:
      kind: Deployment
      name: authentication-service
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 3

  - target:
      kind: Deployment
      name: user-service
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 3

  - target:
      kind: Deployment
      name: transaction-service
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 5

  - target:
      kind: Deployment
      name: wallet-service
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 5

  - target:
      kind: Deployment
      name: api-gateway
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 5

# ConfigMap patches for production
configMapGenerator:
  - name: transaction-service-config
    behavior: merge
    literals:
      - bni-va.mock-enabled=false
      - bni-va.base-url=https://api.bni.co.id  # Production BNI API

  - name: authentication-config
    behavior: merge
    literals:
      - jwt.access-token-duration=15m  # Shorter in prod
      - recaptcha.enabled=true

# Image tags - use specific versions in production
images:
  - name: asia-southeast2-docker.pkg.dev/orange-wallet/orange-wallet-registry/authentication-service
    newTag: v1.0.0  # Use semantic versioning

  - name: asia-southeast2-docker.pkg.dev/orange-wallet/orange-wallet-registry/user-service
    newTag: v1.0.0

  - name: asia-southeast2-docker.pkg.dev/orange-wallet/orange-wallet-registry/transaction-service
    newTag: v1.0.0

  - name: asia-southeast2-docker.pkg.dev/orange-wallet/orange-wallet-registry/wallet-service
    newTag: v1.0.0

  - name: asia-southeast2-docker.pkg.dev/orange-wallet/orange-wallet-registry/api-gateway
    newTag: v1.0.0

# Labels for all resources
labels:
  - pairs:
      environment: prod
      app.kubernetes.io/environment: prod

# Ingress patch for production domain and TLS
patches:
  - target:
      kind: Ingress
      name: orange-wallet-ingress
    patch: |-
      - op: add
        path: /spec/tls
        value:
          - hosts:
              - api.orange-wallet.com
            secretName: orange-wallet-tls
      - op: add
        path: /spec/rules/0/host
        value: api.orange-wallet.com
      - op: replace
        path: /metadata/annotations/nginx.ingress.kubernetes.io~1ssl-redirect
        value: "true"
      - op: add
        path: /metadata/annotations/cert-manager.io~1cluster-issuer
        value: letsencrypt-prod
      - op: replace
        path: /metadata/annotations/nginx.ingress.kubernetes.io~1cors-allow-origin
        value: "https://orange-wallet.com"  # Restrict CORS

  # Remove development backend ingress in production
  - target:
      kind: Ingress
      name: orange-wallet-backend-dev
    patch: |-
      $patch: delete
