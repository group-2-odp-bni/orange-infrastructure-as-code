#cloud-config
# =============================================================================
# Cloud-Init Configuration - K3s Worker Node
# =============================================================================

hostname: ${hostname}

# System packages to install
packages:
  - curl
  - wget
  - git
  - vim
  - htop
  - net-tools
  - jq
  - ca-certificates
  - gnupg
  - lsb-release

# Disable swap (required for Kubernetes)
swap:
  filename: /swapfile
  size: 0

# System configuration
runcmd:
  # Disable swap permanently
  - swapoff -a
  - sed -i '/ swap / s/^/#/' /etc/fstab

  # Load required kernel modules
  - modprobe br_netfilter
  - modprobe overlay

  # Enable kernel modules on boot
  - echo "br_netfilter" >> /etc/modules-load.d/k8s.conf
  - echo "overlay" >> /etc/modules-load.d/k8s.conf

  # Configure sysctl for Kubernetes
  - |
    cat <<EOF > /etc/sysctl.d/k8s.conf
    net.bridge.bridge-nf-call-iptables = 1
    net.bridge.bridge-nf-call-ip6tables = 1
    net.ipv4.ip_forward = 1
    EOF
  - sysctl --system

  # Set hostname
  - hostnamectl set-hostname ${hostname}

  # Create label file for workload type
  - echo "${workload}" > /etc/k3s-workload-type

  # Update system
  - apt-get update
  - apt-get upgrade -y

# Final message
final_message: "K3s worker node (${workload}) cloud-init complete. Ready for Ansible provisioning."
